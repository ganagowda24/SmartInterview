<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üé• Video Practice - Interview Platform</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    /* ‚ú® Glassmorphic + background */
    body {
      background: 
        linear-gradient(rgba(20, 20, 40, 0.7), rgba(50, 20, 70, 0.7)),
        url("https://images.unsplash.com/photo-1522205408450-add114ad53fe?auto=format&fit=crop&w=1600&q=80") 
        no-repeat center center fixed;
      background-size: cover;
      font-family: "Poppins", sans-serif;
      color: #fff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 30px;
    }

    .video-card {
      background: rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(15px);
      border-radius: 25px;
      padding: 40px;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.4);
      max-width: 1000px;
      width: 100%;
      animation: fadeIn 1s ease;
    }

    h3 {
      font-weight: 600;
      text-align: center;
      margin-bottom: 20px;
    }

    .alert-info {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.25);
      color: #fff;
    }

    #videoPreview, #videoPlayback {
      width: 100%;
      border-radius: 20px;
      background: #000;
      min-height: 400px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 25px;
    }

    .btn {
      border-radius: 10px;
      padding: 10px 20px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
    }

    .recording-indicator {
      width: 15px;
      height: 15px;
      background: red;
      border-radius: 50%;
      display: inline-block;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    textarea {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    textarea::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    a.btn-outline-secondary {
      color: #fff;
      border-color: rgba(255, 255, 255, 0.5);
    }

    a.btn-outline-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .error-box {
      background: rgba(255, 255, 255, 0.15);
      border: 2px solid #ffc107;
      padding: 20px;
      border-radius: 15px;
      margin: 20px 0;
      color: #fff8dc;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body>
  <div class="video-card">
    <h3>üé• Video Interview Practice</h3>

    <div class="alert alert-info">
      <strong>üìπ Instructions:</strong><br>
      1. Click ‚ÄúStart Camera‚Äù and allow access<br>
      2. Record your response<br>
      3. Review and submit for analysis
    </div>

    <!-- Error Display -->
    <div id="errorDisplay" class="error-box" style="display:none;">
      <h5>‚ö† Camera Access Issue</h5>
      <p id="errorMessage"></p>
      <div id="errorSolution"></div>
    </div>

    <!-- Question -->
    <div class="card mb-3" id="questionCard" style="background: rgba(255,255,255,0.15); border: none; display:none;">
      <div class="card-body text-white">
        <h5 id="questionText">Loading question...</h5>
        <p id="questionTips" class="text-light"></p>
      </div>
    </div>

    <!-- Video Sections -->
    <div id="previewSection">
      <video id="videoPreview" autoplay muted playsinline></video>
    </div>

    <div id="playbackSection" style="display:none;">
      <video id="videoPlayback" controls playsinline></video>
    </div>

    <!-- Timer -->
    <div class="text-center my-3">
      <h4 id="timer" style="display:none;">‚è±Ô∏è <span id="timerValue">00:00</span></h4>
      <span id="recordingIndicator" style="display:none;">
        <span class="recording-indicator"></span> Recording...
      </span>
    </div>

    <!-- Buttons -->
    <div class="controls">
      <button onclick="startCamera()" class="btn btn-primary" id="startCameraBtn">üìπ Start Camera</button>
      <button onclick="startRecording()" class="btn btn-danger" id="recordBtn" disabled>‚è∫Ô∏è Start Recording</button>
      <button onclick="stopRecording()" class="btn btn-secondary" id="stopBtn" disabled>‚èπÔ∏è Stop</button>
      <button onclick="reviewAnswer()" class="btn btn-info" id="reviewBtn" disabled>‚ñ∂Ô∏è Review</button>
      <button onclick="submitVideoAnswer()" class="btn btn-success" id="submitBtn" disabled>‚úÖ Submit</button>
      <button onclick="retakeAnswer()" class="btn btn-warning" id="retakeBtn" disabled>üîÑ Retake</button>
    </div>

    <!-- Transcription -->
    <div class="mt-4" id="transcriptionSection" style="display:none;">
      <label class="form-label">Type what you said (for analysis):</label>
      <textarea class="form-control" id="transcriptionInput" rows="5" placeholder="Enter your answer text for analysis..."></textarea>
      <small class="text-light">We‚Äôll analyze your text for filler words, keywords, and clarity.</small>
    </div>

    <div class="mt-3 text-center">
      <a href="practice.html" class="btn btn-outline-secondary">‚Üê Back to Text Practice</a>
      <a href="dashboard.html" class="btn btn-outline-secondary">Dashboard</a>
    </div>
  </div>

  <!-- ‚úÖ Integrated JavaScript -->
  <script>
    let token = localStorage.getItem('token');
    let mediaRecorder, recordedChunks = [], stream, timerInterval, startTime;
    let currentSession = null, currentQuestion = null;

    async function loadQuestion() {
      try {
        const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
        const response = await fetch('/api/questions/random?count=1', { headers });
        const result = await response.json();
        if (result.success && result.data.length > 0) {
          currentQuestion = result.data[0];
          document.getElementById('questionText').textContent = currentQuestion.questionText;
          document.getElementById('questionTips').textContent = 'üí° ' + (currentQuestion.tips || 'Good luck!');
          document.getElementById('questionCard').style.display = 'block';
        }
      } catch (e) { console.error(e); }
    }

    async function startCamera() {
      const errorDisplay = document.getElementById('errorDisplay');
      errorDisplay.style.display = 'none';
      try {
        if (!navigator.mediaDevices?.getUserMedia)
          throw new Error('Browser does not support camera access.');
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('videoPreview').srcObject = stream;
        document.getElementById('startCameraBtn').disabled = true;
        document.getElementById('recordBtn').disabled = false;
      } catch (error) {
        const eMsg = document.getElementById('errorMessage');
        const eSol = document.getElementById('errorSolution');
        errorDisplay.style.display = 'block';
        if (error.name === 'NotAllowedError') {
          eMsg.textContent = 'Camera permission denied.';
          eSol.innerHTML = 'Click the üîí icon ‚Üí Allow Camera & Microphone ‚Üí Reload page.';
        } else if (error.name === 'NotReadableError') {
          eMsg.textContent = 'Camera is used by another app.';
          eSol.innerHTML = 'Close Zoom/Teams/other tabs ‚Üí Try again.';
        } else {
          eMsg.textContent = 'Error: ' + error.message;
          eSol.innerHTML = 'Try refreshing or using another browser.';
        }
      }
    }

    function startRecording() {
      if (!stream) return alert('Start camera first');
      recordedChunks = [];
      try {
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
        mediaRecorder.ondataavailable = e => { if (e.data.size) recordedChunks.push(e.data); };
        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: 'video/webm' });
          document.getElementById('videoPlayback').src = URL.createObjectURL(blob);
          document.getElementById('reviewBtn').disabled = false;
          document.getElementById('retakeBtn').disabled = false;
          document.getElementById('transcriptionSection').style.display = 'block';
        };
        mediaRecorder.start();
        startTime = new Date();
        document.getElementById('recordBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;
        document.getElementById('timer').style.display = 'block';
        document.getElementById('recordingIndicator').style.display = 'inline';
        timerInterval = setInterval(() => {
          const elapsed = Math.floor((new Date() - startTime) / 1000);
          const mins = String(Math.floor(elapsed / 60)).padStart(2, '0');
          const secs = String(elapsed % 60).padStart(2, '0');
          document.getElementById('timerValue').textContent = `${mins}:${secs}`;
        }, 1000);
      } catch (e) { alert('Recording error: ' + e.message); }
    }

    function stopRecording() {
      if (mediaRecorder?.state !== 'inactive') {
        mediaRecorder.stop();
        clearInterval(timerInterval);
        document.getElementById('stopBtn').disabled = true;
        document.getElementById('recordingIndicator').style.display = 'none';
      }
    }

    function reviewAnswer() {
      document.getElementById('previewSection').style.display = 'none';
      document.getElementById('playbackSection').style.display = 'block';
      document.getElementById('submitBtn').disabled = false;
    }

    function retakeAnswer() {
      recordedChunks = [];
      document.getElementById('previewSection').style.display = 'block';
      document.getElementById('playbackSection').style.display = 'none';
      document.getElementById('videoPlayback').src = '';
      document.getElementById('recordBtn').disabled = false;
      document.getElementById('reviewBtn').disabled = true;
      document.getElementById('retakeBtn').disabled = true;
      document.getElementById('submitBtn').disabled = true;
      document.getElementById('timer').style.display = 'none';
      document.getElementById('transcriptionInput').value = '';
    }

    async function submitVideoAnswer() {
      const text = document.getElementById('transcriptionInput').value.trim();
      if (!text) return alert('Enter your transcribed answer text before submitting.');
      const duration = startTime ? Math.floor((new Date() - startTime) / 1000) : 60;
      try {
        if (token && !currentSession) {
          const res = await fetch('/api/interview/start?sessionType=Quick', {
            method: 'POST', headers: { 'Authorization': 'Bearer ' + token }
          });
          const result = await res.json();
          if (result.success) currentSession = result.data;
        }
        if (currentSession && currentQuestion) {
          const formData = new URLSearchParams();
          formData.append('sessionId', currentSession.sessionId);
          formData.append('questionId', currentQuestion.questionId);
          formData.append('transcription', text);
          formData.append('duration', duration);
          const response = await fetch('/api/interview/submit-answer', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData
          });
          const result = await response.json();
          if (result.success) {
            alert(`‚úÖ Submitted!\nScore: ${result.data.overallScore}/10\nGo to Dashboard for full feedback.`);
            location.href = 'dashboard.html';
            return;
          }
        }
        alert('‚úÖ Answer saved and analyzed! Check Dashboard for feedback.');
        location.href = 'dashboard.html';
      } catch (e) {
        alert('‚ö† Submission failed: ' + e.message);
      }
    }

    window.addEventListener('beforeunload', () => stream?.getTracks().forEach(t => t.stop()));
    loadQuestion();
  </script>
</body>
</html>
